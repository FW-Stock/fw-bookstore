function logout(){"true"===localStorage.getItem("FW_anonymous")&&firebase.auth().currentUser.delete(),firebase.auth().signOut(),document.location.href="../login",localStorage.setItem("FW_loginChecked","false"),localStorage.setItem("FW_emailUser",null)}$("#f_profile_img").change((function(){$(this).parent().children(".image_chosen").css("backgroundImage",'url("'+URL.createObjectURL(this.files[0])+'")')}));var storage_user,storage_user_param,storage_item,uid,f_profile,db=firebase.firestore(),param=new URLSearchParams(window.location.search),param_id=param.get("id")||"undefined",card_html="";function itemGet(){card_html="",$(".stock_no").text(storage_user_param.items.length);for(let e=0;e<storage_user_param.items.length;e++)db.collection("Item").doc(storage_user_param.items[e]).get().then((async t=>{if(storage_item=t.data(),t.exists){let o="NaN"!==((storage_item.price.ori-storage_item.price.aft)/storage_item.price.ori*100).toFixed(0)?((storage_item.price.ori-storage_item.price.aft)/storage_item.price.ori*100).toFixed(0):"0";card_html+='<div class="col-lg-3 col-md-4 col-sm-6"><div class="card item_card" id="'+t.id+'" onclick="item(\''+t.id+'\')"><div class="card-img-top img" style="background-image: url(\''+storage_item.photo+'\');"></div><div class="card-body"><h5 class="card-title l_item_name">'+storage_item.name+'</h5><p class="card-text l_price">RM <span class="no_price">'+storage_item.price.aft.toFixed(2)+'</span></p><p class="card-text"><span class="l_ori_price">RM <span class="no_oriPrice">'+storage_item.price.ori.toFixed(2)+'</span></span> (<span class="l_discount"><span class="no_discount">'+o+'</span>%</span> Discount)</p><p class="card-text text-muted">'+storage_user_param.name+"</p>",uid===param_id&&(card_html+='<button type="button" class="b_edit" onclick="edit(\''+t.id+'\')">Edit</button><button type="button" class="b_sold" onclick="sold(\''+t.id+'\')">Sold</button><button type="button" class="b_del" onclick="del(\''+t.id+"')\">Delete</button>"),card_html+="</div></div></div>",$(".card_html").html(card_html),await db.collection("Mods-Item").doc(storage_user_param.items[e]).get().then((t=>{void 0!==t.data().Info_log&&(console.log(storage_user_param.items[e]),"Suspended"===t.data().Info_log.action&&($("#"+storage_user_param.items[e]).children().eq(0).html('<span style="display: block; opacity: 1; text-shadow: 1px 1px 2px #EC1E1E, 0 0 1em #333, 0 0 0.2em #333; transform: rotate(-30deg);">SUSPENDED</span>'),$("#"+storage_user_param.items[e]).children().eq(0).css("background-color","#EC1E1E")),"Validating"===t.data().Info_log.action&&($("#"+storage_user_param.items[e]).children().eq(0).html('<span style="display: block; opacity: 1; text-shadow: 1px 1px 2px #865A8D, 0 0 1em #333, 0 0 0.2em #333; transform: rotate(-30deg);">VALIDATING</span>'),$("#"+storage_user_param.items[e]).children().eq(0).css("background-color","#865A8D")),"Sold"===t.data().Info_log.action&&($("#"+storage_user_param.items[e]).children().eq(0).html('<span style="display: block; opacity: 1; text-shadow: 1px 1px 2px #F7A207, 0 0 1em #333, 0 0 0.2em #333; transform: rotate(-30deg);">SOLD SOLD</span>'),$("#"+storage_user_param.items[e]).children().eq(0).css("background-color","#F7A207")),$("#"+storage_user_param.items[e]).children().eq(0).css("opacity",.75),uid!==param_id&&"Sold"!==t.data().Info_log.action&&$("#"+storage_user_param.items[e]).parent().remove())})).catch((e=>{console.log("Cannot get Mods-Item.")}))}})).catch((e=>{console.log("No such document"),console.log(e)}))}function profile(){document.location.href="../profile?id="+uid}function alert(e,t){var o=document.createElement("div");o.innerHTML='<div class="alert alert-'+t+' alert-dismissible d-flex align-items-center mt-2" role="alert"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16" role="img" aria-label="Warning:"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>'+e+'<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>',$("#liveAlertPlaceholder").append(o)}function placeholder(){"messenger"===$("#c_contact")[0].value||"instagram"===$("#c_contact")[0].value?$("#t_contact").attr("placeholder","Social Media Link"):"whatsapp"===$("#c_contact")[0].value?$("#t_contact").attr("placeholder","WhatsApp Phone Number (start with 60)"):$("#t_contact").attr("placeholder","Email")}function update(){""!==$("#t_name")[0].value&&""!==$("#t_contact")[0].value?$("#c_profile_img")[0].checked?""!==$("#f_profile_img")[0].value?checkedRegex(!0):alert("Please upload new profile image, or uncheck it.","warning"):checkedRegex(!1):alert("Please filled in all requierd information.","warning")}function checkedRegex(e){"messenger"===$("#c_contact")[0].value&&(/http(?:s):\/\/(?:www\.)messenger\.com\/[t]\/\d*/.test($("#t_contact")[0].value)?validated(e):alert("Invalid link. Please follow this link format: https://www.messenger.com/t/xxxxx","warning")),"instagram"===$("#c_contact")[0].value&&(/(?:(?:http|https):\/\/)?(?:www\.)?(?:instagram\.com|instagr\.am)\/([A-Za-z0-9-_\.]+)/im.test($("#t_contact")[0].value)?validated(e):alert("Invalid link. Please follow this link format: https://www.instagram.com/xxxxx","warning")),"whatsapp"===$("#c_contact")[0].value&&(/^[6](6?01)[02-46-9]-*[0-9]{7}$|^[6](6?01)[1]-*[0-9]{8}$|^[6](6?04)-*[0-9]{7}/gm.test($("#t_contact")[0].value)?validated(e):alert("Invalid WhatsApp phone number. Please follow this link format: 601xxxxxxx. Currently not supporting Non-Malaysia WhatsApp Phone Number format","warning")),"email"===$("#c_contact")[0].value&&(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test($("#t_contact")[0].value)?validated(e):alert("Invalid email address.","warning"))}async function validated(e){e&&($("#b_update").addClass("disabled"),await firebase.storage().ref("profile/"+uid).listAll().then((e=>{0!==e.items.length&&e.items.forEach((e=>{firebase.storage().ref("profile/"+uid+"/"+e.name).delete().then((()=>{console.log("Item deleted")})).catch((e=>{console.log("Error deleting item: "+e)}))}))})).catch((e=>{console.error("Error writing document Profile: ",e)})),await firebase.storage().ref("profile/"+uid+"/"+f_profile.name).put(f_profile).then((e=>{console.log("Uploaded file Profile!"),firebase.storage().ref("profile/"+uid+"/"+f_profile.name).getDownloadURL().then((e=>{db.collection("Users").doc(uid).set({photo:e},{merge:!0}).then((()=>{console.log("Document successfully written Profile!")})).catch((e=>{console.error("Error writing document Profile: ",e),alert("Failed to upload profile image. Please re-upload.","danger")}))}))}))),db.collection("Users").doc(uid).set({name:$("#t_name")[0].value,contact:{link:$("#t_contact")[0].value,provider:$("#c_contact")[0].value},school:$("#t_school")[0].value},{merge:!0}).catch((e=>{console.error("Error getting document Users: "+e)})),swal({title:"Successfully updated your public information!",icon:"success",button:"Close",position:"top-end"}).then((e=>{e&&document.location.reload()})),setTimeout((function(){document.location.reload()}),2e3)}function upgrade(){$(".overlay").css("display","block")}function close_declare(){$(".overlay").css("display","none")}function agree(){let e,t;void 0===storage_user.contact?(e="email",t=storage_user.email):(e=storage_user.contact.provider,t=storage_user.contact.link),db.collection("Users").doc(uid).set({contact:{provider:e,link:t},items:[],school:$("#t_school")[0].value,sent:!0},{merge:!0}).catch((e=>{console.error("Error getting document Users: "+e)})),swal({title:"Your request as a seller has sent to the mods!",text:"Your request will be processed around 2 days!",icon:"success",button:"Close",position:"top-end"}),$(".overlay").css("display","none")}firebase.auth().onAuthStateChanged((async e=>{e?(uid=e.uid,db.collection("Users").doc(uid).get().then((async e=>{e.exists?(storage_user=e.data(),$("#b_user").children("i").attr("class",""),$("#i_profile").attr("src",storage_user.photo)):($("#i_profile").css("display","none"),console.log("No such document!")),db.collection("Users").doc(param_id).get().then((async e=>{e.exists?(storage_user_param=e.data(),$(".l_profile_name").text(storage_user_param.name),$("title").text(storage_user_param.name),$(".l_school").text(storage_user_param.school),void 0!==storage_user_param.contact?"messenger"===storage_user_param.contact.provider||"instagram"===storage_user_param.contact.provider?$(".l_contact").attr("href",storage_user_param.contact.link):"whatsapp"===storage_user_param.contact.provider?$(".l_contact").attr("href","https://api.whatsapp.com/send?phone="+storage_user_param.contact.link):$(".l_contact").attr("href","mailto:"+storage_user_param.contact.link):$(".l_contact").attr("href","mailto:"+storage_user_param.email),void 0!==storage_user_param.photo?$(".img_profile").css("backgroundImage","url('"+storage_user_param.photo+"')"):$(".img_profile").css("backgroundImage","url('../images/favicon/favicon-512.png')"),db.collection("Mods-Users").doc(param_id).get().then((async e=>{storage_user_mods=e.data(),storage_user_mods.seller?($(".l_badge").addClass("l_seller"),$(".badge_type").text("Seller")):($(".l_badge").addClass("l_registered"),$(".badge_type").text("Registered")),storage_user_mods.mods&&$(".l_mods").css("display","inline-table"),uid===param_id?($("#t_name")[0].value=storage_user.name,void 0!==storage_user.school?$("#t_school")[0].value=storage_user.school:$("#t_school")[0].value="",storage_user_mods.seller?($("#c_contact")[0].value=storage_user.contact.provider,$("#t_contact")[0].value=storage_user.contact.link,placeholder()):($("#b_upgrade").css("display","block"),$("#c_contact")[0].value="email",$("#t_contact")[0].value=storage_user.email,placeholder())):($("#seller").html(""),$("#b_new").css("display","none")),storage_user_mods.seller?""!=storage_user_param.items?itemGet():$(".card_html").html("&nbsp; &nbsp; &nbsp; No item is selling now."):$("#stock").html("")})).catch((e=>{console.log("Error getting document Users",e)}))):("true"===localStorage.getItem("FW_anonymous")?$(".main").html("&nbsp;&nbsp;Detect anonymous login. <a href='javascript: logout()'>Login / Register</a>"):$(".main").html("&nbsp;&nbsp;No such user! <a href='javascript: logout()'>Login / Register</a>"),console.log("No such document User Param!"))})).catch((e=>{console.log("Error getting document Users",e)}))})).catch((e=>{console.log("Error getting document Users",e)}))):$(".main").html("&nbsp;&nbsp;Detect anonymous login. <a href='javascript: logout()''>Login / Register</a>")})),$("#b_back").click((function(){0===document.referrer.indexOf(location.protocol+"//"+location.host)&&history.length>1?window.history.back():document.location.href="../"})),$("#c_contact").change((function(){placeholder()})),$("#c_profile_img").change((function(){$("#c_profile_img")[0].checked?$("#f_profile_img")[0].removeAttribute("disabled"):$("#f_profile_img")[0].setAttribute("disabled","")})),$("#f_profile_img").change((function(){f_profile=this.files[0]})),$("#b_new").click((function(){document.location.href="../studio?action=upload"}));var deleteID,first=1;function edit(e){first=0,document.location.href="../studio?action=edit&id="+e}function sold(e){first=0,console.log(1),swal({icon:"warning",dangerMode:!0,buttons:!0,position:"top-end",text:"This action is permanent and not recoverable after done. Item that is marked as sold will be closed forever.",title:"Are you sure you want to mark this item as sold?"}).then((t=>{t&&(db.collection("Mods-Item").doc(e).set({Info_log:{action:"Sold",reason:"",time:firebase.firestore.FieldValue.serverTimestamp(),uid:uid}},{merge:!0}).then((()=>{console.log("Document successfully written Mods-User!")})),$("#"+e).children().eq(0).html('<span style="display: block; opacity: 1; text-shadow: 1px 1px 2px #F7A207, 0 0 1em #333, 0 0 0.2em #333; transform: rotate(-30deg);">SOLD SOLD</span>'),$("#"+e).children().eq(0).css("background-color","#F7A207"))})).catch((e=>{console.error("Error marking document as sold: ",e)}))}function del(e){deleteID=e,first=0,swal({icon:"warning",dangerMode:!0,buttons:!0,position:"top-end",text:"This action is permanent and not recoverable after done. This item will be deleted forever.",title:"Are you sure you want to permanently delete this item?"}).then((e=>{e?(storage_user_param.items.splice(storage_user_param.items.indexOf(deleteID),1),db.collection("Item").doc(deleteID).delete().then((()=>{db.collection("Users").doc(uid).set({items:storage_user_param.items},{merge:!0}).then((()=>{console.log("Document successfully written!")})).catch((e=>{console.error("Error writing document User: ",e)})),console.log("Document successfully deleted!"),swal({title:"Document successfully deleted!",text:"You have saved the storage space of FW Bookstore!",icon:"success",button:"Close",position:"top-end"}),itemGet()})).catch((e=>{console.error("Error removing document: ",e)})),db.collection("Mods-Item").doc(deleteID).delete().then((()=>{firebase.storage().ref("images/"+deleteID).listAll().then((e=>{e.items.forEach((e=>{firebase.storage().ref("images/"+deleteID+"/"+e.name).delete().then((()=>{console.log("Document images deleted")})).catch((e=>{console.log("Error deleting document images: "+e)}))}))})).catch((e=>{console.error("Error writing document Mods-Item: ",e)}))})).catch((e=>{console.error("Error removing document Mods-Item: ",e)}))):swal("Your item is safe!")}))}function item(e){first&&(document.location.href="../item?id="+e)}
